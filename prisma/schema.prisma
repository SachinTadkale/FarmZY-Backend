datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//////////////////////
// ENUMS
//////////////////////

enum VerificationStatus {
  APPROVED
  REJECTED
  PENDING
}

enum ListingType {
  SALE
  REQUIRED
}

enum ListingStatus {
  ACTIVE
  CLOSED
}

enum PaymentStatus {
  INITIATED
  PROCESSING
  PAID
  FAILED
  REFUNDED
}

enum OrderStatus {
  CREATED
  PROCESSING
  DELIVERED
  CANCELED
}

enum BankAccountType {
  SAVING
  CURRENT
}

enum PaymentReviewStatus {
  PENDING
  REPORTED
  CONFIRMED
  FLAGGED
}

enum OtpType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  PASSWORD_RESET
}

//////////////////////
// MODELS
//////////////////////

model User {
  user_id            String              @id @default(uuid())
  name               String
  phone_no           String
  password           String
  address            String
  verificationStatus VerificationStatus  @default(PENDING)
  email              String              @unique
  createdAt          DateTime            @default(now())

  listings           MarketListing[]
  notifications      Notification[]
  payments           Payment[]
  bankDetails        BankDetails[]
  products           Product[]   
}


model Company {
  companyId        String              @id @default(uuid())
  companyName      String
  registrationNo   String              @unique
  hqLocation       String
  gstNumber        String              @unique
  verification     VerificationStatus  @default(PENDING)
  createdAt        DateTime            @default(now())

  inventories      Inventory[]
  orders           Order[]
  payments         Payment[]
}

model Inventory {
  stockId      String   @id @default(uuid())
  companyId    String
  stockName    String
  stockWeight  Float
  stockPrice   Float

  company      Company  @relation(fields: [companyId], references: [companyId])
}

model Product {
  productId      String   @id @default(uuid())
  productName    String
  category       String
  unit           String
  productImage   String?
  userId         String

  user           User     @relation(fields: [userId], references: [user_id])
  listings       MarketListing[]
}


model MarketListing {
  listingId     String         @id @default(uuid())
  sellerId      String
  productId     String
  listingType   ListingType
  status        ListingStatus  @default(ACTIVE)
  createdAt     DateTime       @default(now())

  seller        User           @relation(fields: [sellerId], references: [user_id])
  product       Product        @relation(fields: [productId], references: [productId])
  orders        Order[]
}

model Order {
  orderId        String        @id @default(uuid())
  listingId      String
  companyId      String
  finalPrice     Float
  paymentStatus  PaymentStatus @default(INITIATED)
  orderStatus    OrderStatus   @default(CREATED)
  createdAt      DateTime      @default(now())

  listing        MarketListing @relation(fields: [listingId], references: [listingId])
  company        Company       @relation(fields: [companyId], references: [companyId])
  payments       Payment[]
}

model Notification {
  nId        String   @id @default(uuid())
  userId     String
  message    String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [user_id])
}

model Payment {
  paymentId        String              @id @default(uuid())
  orderId          String
  companyId        String
  userId           String
  grossAmount      Float
  platformFee      Float
  netAmount        Float
  paymentStatus    PaymentReviewStatus @default(PENDING)
  bankReferenceNo  String?
  proofUrl         String?
  reportedAt       DateTime?
  confirmedAt      DateTime?

  order            Order    @relation(fields: [orderId], references: [orderId])
  company          Company  @relation(fields: [companyId], references: [companyId])
  user             User     @relation(fields: [userId], references: [user_id])
  transactions     Transaction[]
}

model BankDetails {
  accountNumber   String          @id
  userId          String
  accountHolder   String
  ifsc            String
  accountType     BankAccountType

  user            User            @relation(fields: [userId], references: [user_id])
  transactions    Transaction[]
}

model Transaction {
  transactionId   String       @id @default(uuid())
  accountNumber   String
  paymentId       String

  bankDetails     BankDetails  @relation(fields: [accountNumber], references: [accountNumber])
  payment         Payment      @relation(fields: [paymentId], references: [paymentId])
}

model Otp {
  otpId       String   @id @default(uuid())
  userId      String
  code        String
  type        OtpType
  isUsed      Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [user_id])
}
